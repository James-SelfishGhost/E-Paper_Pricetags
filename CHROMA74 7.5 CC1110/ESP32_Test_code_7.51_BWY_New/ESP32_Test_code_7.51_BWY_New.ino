#include <SPI.h>

uint8_t lut00[] = {0x01, 0x05, 0x00, 0x01, 0x07, 0x01, 0x06, 0x3C, 0x01, 0x02, 0x00, 0x30, 0x3C, 0x01, 0xDD, 0x00};
uint8_t lut20[] = {0x20, 0x01, 0x09, 0x40, 0x32, 0x32, 0x1C, 0x4B, 0x34, 0x00, 0x00, 0x00, 0x01, 0x90, 0x00, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xA5, 0x00, 0x32, 0x32, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x4B, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x03, 0x90, 0x00, 0x64, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x58, 0x00, 0x03, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x4B, 0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x04, 0x00, 0x2D, 0x0A, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x2D, 0x14, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x2D, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x05, 0x01};
uint8_t lut22[] = {0x22, 0x01, 0x00, 0x11, 0x10, 0x00, 0x32, 0x32, 0x1C, 0x4B, 0x34, 0x00, 0x00, 0x00, 0x01, 0x12, 0x00, 0x00, 0x00, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x00, 0x00, 0x32, 0x32, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x4B, 0x12, 0x12, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x03, 0x12, 0x00, 0x00, 0x00, 0x64, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x22, 0x20, 0x00, 0x00, 0x03, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x4B, 0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x10, 0x00, 0x00, 0x2D, 0x0A, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x2D, 0x14, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x2D, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x20, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x05, 0x01};
uint8_t lut21[] = {0x21, 0x01, 0x00, 0x22, 0x20, 0x00, 0x32, 0x32, 0x1C, 0x4B, 0x34, 0x00, 0x00, 0x00, 0x01, 0x12, 0x00, 0x00, 0x00, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x22, 0x00, 0x00, 0x32, 0x32, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x4B, 0x12, 0x12, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x03, 0x12, 0x00, 0x00, 0x00, 0x64, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x11, 0x10, 0x00, 0x00, 0x03, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x4B, 0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x10, 0x00, 0x00, 0x2D, 0x0A, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x2D, 0x14, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x2D, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x01, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x05, 0x01};
uint8_t lut25[] = {0x25, 0x01, 0x00, 0x21, 0x20, 0x00, 0x32, 0x32, 0x1C, 0x4B, 0x34, 0x00, 0x00, 0x00, 0x01, 0x12, 0x00, 0x00, 0x00, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x22, 0x00, 0x00, 0x32, 0x32, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x4B, 0x12, 0x12, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x03, 0x12, 0x00, 0x00, 0x00, 0x64, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x10, 0x20, 0x00, 0x00, 0x03, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x33, 0x00, 0x00, 0x00, 0x4B, 0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x30, 0x20, 0x00, 0x00, 0x2D, 0x0A, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x30, 0x20, 0x00, 0x00, 0x2D, 0x14, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x30, 0x20, 0x00, 0x00, 0x2D, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xC9, 0x00};
uint8_t lut29[] = {0x29, 0x01, 0x3F, 0x32, 0x32, 0x1C, 0x4B, 0x34, 0x00, 0x00, 0x00, 0x01, 0xFF, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xFF, 0x32, 0x32, 0x32, 0x32, 0x00, 0x00, 0x00, 0x00, 0x4B, 0xFF, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF, 0x64, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0xFF, 0x03, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xFF, 0x4B, 0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0xFF, 0x2D, 0x0A, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xFF, 0x2D, 0x14, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xFF, 0x2D, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0xFF, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

#define epd_clk 7
#define epd_mosi 11
#define epd_cs 37
#define epd_dc 16
#define epd_rst 39
#define epd_busy 18

void epd_cmd(uint8_t data) {
  SPI.beginTransaction(SPISettings(4000000, MSBFIRST, SPI_MODE0));
  digitalWrite(epd_dc, LOW);
  digitalWrite(epd_cs, LOW);
  SPI.transfer(data);
  digitalWrite(epd_cs, HIGH);
  SPI.endTransaction();
}

void epd_data(uint8_t data) {
  SPI.beginTransaction(SPISettings(4000000, MSBFIRST, SPI_MODE0));
  digitalWrite(epd_dc, HIGH);
  digitalWrite(epd_cs, LOW);
  SPI.transfer(data);
  digitalWrite(epd_cs, HIGH);
  SPI.endTransaction();
}

void wait_busy() {
  delay(2);
  int start_time = millis();
  while (!digitalRead(epd_busy)) {}
  Serial.print("Time:");
  Serial.println(millis() - start_time);
}

void send_lut(uint8_t lut[]) {
  epd_cmd(lut[0]);
  for (int r = 1; r <= sizeof(lut20); r++)
  {
    epd_data(lut[r]);
  }
}

void send_empty_lut(uint8_t lut) {
  epd_cmd(lut);
  for (int r = 0; r <= 260; r++)
    epd_data(0x00);
}

void setup() {
  Serial.begin(115200);
  SPI.begin();

  pinMode(epd_cs, OUTPUT);
  pinMode(epd_dc, OUTPUT);
  pinMode(epd_rst, OUTPUT);
  pinMode(epd_busy, INPUT);
  digitalWrite(epd_cs, HIGH);
  digitalWrite(epd_rst, HIGH);
  delay(100);
  digitalWrite(epd_rst, LOW);
  delay(100);
  digitalWrite(epd_rst, HIGH);
  delay(100);

  epd_cmd(0x61);
  epd_data(0x02);
  epd_data(0x80);
  epd_data(0x01);
  epd_data(0x80);

  epd_cmd(0x06);
  epd_data(0x0e);
  epd_data(0xcd);
  epd_data(0x26);

  epd_cmd(0x00);
  epd_data(0xEF);
  epd_data(0x80);

  epd_cmd(0x03);
  epd_data(0x00);

  epd_cmd(0x82);
  epd_data(0x22);

  epd_cmd(0x60);
  epd_data(0x22);

  epd_cmd(0x41);
  epd_data(0x80);

  epd_cmd(0x50);
  epd_data(0x77);

  epd_cmd(0x65);
  epd_data(0x00);

  //Send data to be displayed
  epd_cmd(0x10);
   for (int r = 1; r <= 122880; r++)
    {
      //0000 = Black
      //0100 = Yellow
      //0011 = White
     epd_data(0b01000000);
    }
  //**Here is LUT special stuff **//
  epd_cmd(0x01);
  epd_data(0x07);
  epd_data(0x01);
  epd_data(0x01);
  epd_data(0x3c);

  epd_cmd(0x30);
  epd_data(0x3A);

  //Unused LUTs need to be 0x00
  send_empty_lut(0x23);
  send_empty_lut(0x24);
  send_empty_lut(0x26);
  send_empty_lut(0x27);
  send_empty_lut(0x28);

  //Send LUTs from array
  send_lut(lut20);
  send_lut(lut22);
  send_lut(lut21);
  send_lut(lut25);
  send_lut(lut29);

  //Power ON
  epd_cmd(0x04);
  wait_busy();

  Serial.println("Refreshing ");
  epd_cmd(0x12);
  wait_busy();

  //Power OFF
  epd_cmd(0x02);

  //Sleep
  epd_cmd(0x07);
  epd_data(0xA5);
}

void loop() {

}
